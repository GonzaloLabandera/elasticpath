<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
	<modelVersion>4.0.0</modelVersion>

	<parent>
		<groupId>com.elasticpath.cmclient</groupId>
		<artifactId>cm-parent</artifactId>
		<version>703.0.0-SNAPSHOT</version>
		<relativePath>../pom.xml</relativePath>
	</parent>

	<artifactId>cm-modules</artifactId>
	<version>703.0.0-SNAPSHOT</version><!-- Version is required here for releasing tasks -->
	<packaging>pom</packaging>
	<name>CM Modules</name>
	<description> Contains the MANIFEST-first tycho modules, separated from the pom-first modules.</description>

	<properties>
		<tycho.version>1.0.0</tycho.version>
		<tycho.target-platform>cm-rap32</tycho.target-platform>
		<tycho.target-platform.version>${project.version}</tycho.target-platform.version>
		<pmd.cmclient.ruleset>rulesets/pmd-elasticpath-cmclient-rules.xml</pmd.cmclient.ruleset>
		<checkstyle.ruleset>rulesets/checkstyle-elasticpath-rules.xml</checkstyle.ruleset>
		<checkstyle.suppressions.location>cm-ruleset/checkstyle-cmclient-suppressions.xml</checkstyle.suppressions.location>
		<solr.version>4.5.1</solr.version>
		<sling-plugin.version>2.1.0</sling-plugin.version>
		<org.apache.batic.version>1.6.0.v201011041432</org.apache.batic.version>
		<org.eclipse.emf.version>2.12.0.v20160420-0247</org.eclipse.emf.version>
	</properties>

	<repositories>
		<repository>
			<id>RAP</id>
			<url>http://download.eclipse.org/rt/rap/3.4</url>
			<layout>p2</layout>
		</repository>
		<repository>
			<id>OxygenRepository</id>
			<url>http://download.eclipse.org/releases/oxygen</url>
			<layout>p2</layout>
		</repository>
	</repositories>

	<build>
		<testOutputDirectory>${project.build.outputDirectory}</testOutputDirectory>
		<plugins>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-compiler-plugin</artifactId>
				<configuration>
					<verbose>true</verbose>
					<debug>true</debug>
					<showDeprecation>false</showDeprecation>
					<failOnError>false</failOnError>
				</configuration>
				<executions>
					<execution>
						<goals>
							<goal>testCompile</goal>
						</goals>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-surefire-plugin</artifactId>
				<executions>
					<execution>
						<goals>
							<goal>test</goal>
						</goals>
						<configuration>
							<useSystemClassLoader>false</useSystemClassLoader>
							<classpathDependencyExcludes>
								<classpathDependencyExclude>javax.servlet:javax.servlet-api</classpathDependencyExclude>
							</classpathDependencyExcludes>
						</configuration>
					</execution>
				</executions>
			</plugin>
			<plugin>
				<groupId>org.eclipse.tycho</groupId>
				<artifactId>tycho-maven-plugin</artifactId>
				<extensions>true</extensions>
				<version>${tycho.version}</version>
			</plugin>
			<plugin>
				<groupId>org.eclipse.tycho</groupId>
				<artifactId>target-platform-configuration</artifactId>
				<version>${tycho.version}</version>
				<configuration>
					<resolver>p2</resolver>
					<pomDependencies>consider</pomDependencies>
					<target>
						<artifact>
							<groupId>com.elasticpath.cmclient</groupId>
							<artifactId>target-platform</artifactId>
							<version>${tycho.target-platform.version}</version>
							<classifier>${tycho.target-platform}</classifier>
						</artifact>
					</target>
					<ignoreTychoRepositories>true</ignoreTychoRepositories>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.eclipse.tycho</groupId>
				<artifactId>tycho-packaging-plugin</artifactId>
				<version>${tycho.version}</version>
				<configuration>
					<format>yyyyMMddHH</format>
				</configuration>
			</plugin>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-checkstyle-plugin</artifactId>
			</plugin>
			<plugin>
				<groupId>org.apache.maven.plugins</groupId>
				<artifactId>maven-pmd-plugin</artifactId>
				<configuration>
					<rulesets>
						<ruleset>${pmd.cmclient.ruleset}</ruleset>
					</rulesets>
				</configuration>
			</plugin>
		</plugins>
		<pluginManagement>
			<plugins>
				<plugin>
					<groupId>org.apache.maven.plugins</groupId>
					<artifactId>maven-install-plugin</artifactId>
				</plugin>
				<plugin>
					<groupId>org.apache.maven.plugins</groupId>
					<artifactId>maven-deploy-plugin</artifactId>
				</plugin>
				<plugin>
					<groupId>org.apache.maven.plugins</groupId>
					<artifactId>maven-scm-plugin</artifactId>
					<version>1.5</version>
					<configuration>
						<!-- We define properties here so that maven-jenkins-plugin doesn't resolve them when building build jobs. -->

						<!-- connectionUrl specified due to a bug in the git provider of the maven-scm-plugin, see SCM-179 for similar issue. -->
						<!-- Generally in git, connectionUrl is read-only, while developerConnection is read/write -->
						<connectionUrl>${project.scm.developerConnection}</connectionUrl>
					</configuration>
				</plugin>
			</plugins>
		</pluginManagement>
	</build>

	<modules>
		<module>target-platform</module>
		<module>cm-plugins</module>
		<module>com.elasticpath.cmclient.platform.feature</module>
		<module>cm-p2-repository</module>
	</modules>

	<profiles>
		<profile>
			<id>release</id>
			<build>
				<plugins>
					<plugin>
						<artifactId>maven-source-plugin</artifactId>
						<executions>
							<execution>
								<id>attach-sources</id>
								<phase>none</phase>
							</execution>
							<execution>
								<id>default</id>
								<phase>none</phase>
							</execution>
						</executions>
					</plugin>
					<plugin>
						<groupId>org.eclipse.tycho</groupId>
						<artifactId>tycho-source-plugin</artifactId>
						<version>${tycho.version}</version>
						<executions>
							<execution>
								<goals>
									<goal>plugin-source</goal>
								</goals>
							</execution>
						</executions>
					</plugin>
				</plugins>
			</build>
		</profile>

		<profile>
			<id>with-translations</id>
			<modules>
				<module>translations</module>
			</modules>
		</profile>

		<profile>
			<id>m2e-lifecycle-mapping</id>
			<activation>
				<property>
					<name>m2e.version</name>
				</property>
			</activation>
			<build>
				<plugins>
					<plugin>
						<groupId>org.eclipse.m2e.settings</groupId>
						<artifactId>maven-m2e-settings-plugin</artifactId>
						<version>1.2.1.20121108-ep1</version>
						<configuration>
							<formatter>
								<filename>eclipse/cmclient-jdt.core.prefs.xml</filename>
								<profile>elasticpath</profile>
							</formatter>
						</configuration>
						<executions>
							<execution>
								<goals>
									<goal>set-settings</goal>
								</goals>
							</execution>
						</executions>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>hot-deploy-tomcat</id>
			<build>
				<plugins>
					<plugin>
						<groupId>org.apache.maven.plugins</groupId>
						<artifactId>maven-antrun-plugin</artifactId>
						<executions>
							<execution>
								<id>bundle-hot-deploy</id>
								<phase>install</phase>
								<configuration>
									<target>
										<delete verbose="true">
											<fileset dir="${web.cm.deployment.dir}/WEB-INF/eclipse/plugins"
													 includes="${project.artifactId}*.jar"/>
										</delete>
										<copy verbose="true" file="${project.build.directory}/${project.build.finalName}.jar"
											  todir="${web.cm.deployment.dir}/WEB-INF/eclipse/plugins"/>
										<touch verbose="true" datetime="now" file="${web.cm.deployment.dir}/../../conf/context.xml"/>
									</target>
								</configuration>
								<goals>
									<goal>run</goal>
								</goals>
							</execution>
						</executions>
					</plugin>
				</plugins>
			</build>
		</profile>
		<profile>
			<id>hot-deploy-sling</id>
			<build>
				<plugins>
					<plugin>
						<groupId>org.apache.sling</groupId>
						<artifactId>maven-sling-plugin</artifactId>
						<version>${sling-plugin.version}</version>
						<executions>
							<execution>
								<id>uninstall-bundle</id>
								<phase>install</phase>
								<goals>
									<goal>uninstall</goal>
								</goals>
							</execution>
							<execution>
								<id>install-bundle</id>
								<phase>install</phase>
								<goals>
									<goal>install</goal>
								</goals>
								<configuration>
									<bundleStartLevel>4</bundleStartLevel>
								</configuration>
							</execution>
						</executions>
					</plugin>
				</plugins>
			</build>

		</profile>
	</profiles>

</project>
