<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	   xmlns:util="http://www.springframework.org/schema/util"
	   xmlns:settings="http://www.elasticpath.com/schema/settings"
	   xsi:schemaLocation="
				http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd
				http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.0.xsd
				http://www.elasticpath.com/schema/settings http://www.elasticpath.com/schema/settings/settings.xsd
		">
	<import resource="classpath*:META-INF/elasticpath/conf/spring/beans.xml" />

	<import resource="hds-support.xml"/>

	<!-- empty for use in extension projects -->
	<util:list id="persistenceMappingExcludedFiles"/>
	<util:list id="persistenceMappingExcludedClasses"/>
	<util:list id="persistenceMappingExcludedJarFileUrls"/>
	<util:map id="persistencePropertyOverrides" key-type="java.lang.String"/>

	<util:list id="persistenceUnitPostProcessors">
		<bean class="com.elasticpath.persistence.openjpa.impl.MergingPersistenceUnitPostProcessor"/>
		<ref bean="overridingPersistenceUnitPostProcessor"/>
		<bean class="com.elasticpath.persistence.openjpa.impl.RemoveTrailingBackslashPersistenceUnitPostProcessor"/>
	</util:list>

	<bean id="defaultOverridingPersistenceUnitPostProcessor" class="com.elasticpath.persistence.openjpa.impl.OverridingPersistenceUnitPostProcessor">
		<property name="persistenceUnitName" value="commerce-persistence-unit"/>
		<property name="excludedMappingFiles" ref="persistenceMappingExcludedFiles"/>
		<property name="excludedManagedClassNames" ref="persistenceMappingExcludedClasses"/>
		<property name="excludedJarFileUrls" ref="persistenceMappingExcludedJarFileUrls"/>
		<property name="propertyOverrides" ref="persistencePropertyOverrides"/>
		<property name="excludeUnlistedClasses" value="true"/>
	</bean>

	<alias name="defaultOverridingPersistenceUnitPostProcessor" alias="overridingPersistenceUnitPostProcessor"/>

	<!--  These listeners will be attached by the factory to every EntityManager on creation.
		  Note that these are OpenJPA LifecycleListeners.  Some of these listeners may <em>also</em> be EP PersistenceEngineEntityListeners.
		  PersistenceEngineOperationListeners are associated directly with the EP PersistenceEngine, not the OpenJPA EntityManager,
		  so any listeners which do double duty listening to both interfaces must be registered in both locations. -->
	<util:list id="entityManagerLifecycleListeners">
		<ref bean="domainEventListener"/>
		<ref bean="databaseTimestampsEntityListener"/>
		<ref bean="objectDeletedEntityListener"/>
		<ref bean="changeSetPersistenceListener"/>
		<ref bean="persistablePostLoadListener"/>
		<!--<ref bean="auditEntityListener"/>-->    <!-- Must also be registered in the PersistenceEngine -->
	</util:list>

	<bean id="sharedEntityManager" class="org.springframework.orm.jpa.support.SharedEntityManagerBean">
		<property name="entityManagerFactory">
			<ref bean="entityManagerFactory"/>
		</property>
	</bean>

	<bean id="eventTypeFactory" class="com.elasticpath.persistence.impl.DomainEventTypeFactoryImpl">
		<constructor-arg name="supportedClassByEventTypes" ref="classByEventTypesMap"/>
	</bean>

	<util:map id="classByEventTypesMap" key-type="java.lang.Class" value-type="java.util.List">
		<entry key="com.elasticpath.domain.skuconfiguration.impl.SkuOptionImpl">
			<list value-type="java.lang.String">
				<value>SKU_OPTION_CREATED</value>
				<value>SKU_OPTION_UPDATED</value>
				<value>SKU_OPTION_DELETED</value>
			</list>
		</entry>
		<entry key="com.elasticpath.domain.catalog.impl.BrandImpl">
			<list value-type="java.lang.String">
				<value>BRAND_CREATED</value>
				<value>BRAND_UPDATED</value>
				<value>BRAND_DELETED</value>
			</list>
		</entry>
		<entry key="com.elasticpath.domain.modifier.impl.ModifierGroupImpl">
			<list value-type="java.lang.String">
				<value>MODIFIER_GROUP_CREATED</value>
				<value>MODIFIER_GROUP_UPDATED</value>
				<value>MODIFIER_GROUP_DELETED</value>
			</list>
		</entry>
		<entry key="com.elasticpath.domain.attribute.impl.AttributeImpl">
			<list value-type="java.lang.String">
				<value>ATTRIBUTE_CREATED</value>
				<value>ATTRIBUTE_UPDATED</value>
				<value>ATTRIBUTE_DELETED</value>
			</list>
		</entry>
		<entry key="com.elasticpath.domain.catalog.impl.ProductImpl">
			<list value-type="java.lang.String">
				<value>PRODUCT_CREATED</value>
				<value>PRODUCT_UPDATED</value>
				<value>PRODUCT_DELETED</value>
			</list>
		</entry>
		<entry key="com.elasticpath.domain.catalog.impl.ProductBundleImpl">
			<list value-type="java.lang.String">
				<value>PRODUCT_CREATED</value>
				<value>PRODUCT_UPDATED</value>
				<value>PRODUCT_DELETED</value>
			</list>
		</entry>
		<entry key="com.elasticpath.domain.catalog.impl.CategoryImpl">
			<list value-type="java.lang.String">
				<value>CATEGORY_CREATED</value>
				<value>CATEGORY_UPDATED</value>
				<value>CATEGORY_DELETED</value>
			</list>
		</entry>
		<entry key="com.elasticpath.domain.catalog.impl.LinkedCategoryImpl">
			<list value-type="java.lang.String">
				<value>CATEGORY_LINK_CREATED</value>
				<value>CATEGORY_LINK_UPDATED</value>
				<value>CATEGORY_LINK_DELETED</value>
			</list>
		</entry>
	</util:map>

	<util:list id="domainEventListenerEventTypes">
		<util:constant static-field="org.apache.openjpa.event.LifecycleEvent.AFTER_PERSIST_PERFORMED"/>
		<util:constant static-field="org.apache.openjpa.event.LifecycleEvent.AFTER_ATTACH"/>
		<util:constant static-field="org.apache.openjpa.event.LifecycleEvent.AFTER_DELETE"/>
	</util:list>

	<bean id="domainEventListener"  class="com.elasticpath.persistence.impl.DomainEventListener">
		<property name="beanFactory" ref="coreBeanFactory"/>
		<property name="eventMessagePublisher" ref="domainEventMessagePublisher"/>
		<property name="eventMessageFactory" ref="eventMessageFactory"/>
		<property name="eventTypeFactory" ref="eventTypeFactory"/>
		<property name="eventTypes" ref="domainEventListenerEventTypes" />
	</bean>

	<bean id="databaseTimestampsEntityListener" class="com.elasticpath.persistence.impl.DatabaseTimestampsEntityListener">
		<property name="beanFactory" ref="coreBeanFactory"/>
	</bean>

	<bean id="objectDeletedEntityListener" class="com.elasticpath.persistence.impl.ObjectDeletedEntityListener">
		<property name="beanFactory" ref="coreBeanFactory"/>
	</bean>

	<bean id="auditEntityListener" class="com.elasticpath.persistence.impl.AuditEntityListener">
		<property name="beanFactory" ref="coreBeanFactory"/>
		<property name="auditableClasses">
			<set>
				<value>com.elasticpath.domain.attribute.impl.AbstractAttributeValueImpl</value>
				<value>com.elasticpath.domain.attribute.impl.ProductAttributeValueImpl</value>
				<value>com.elasticpath.domain.attribute.impl.SkuAttributeValueImpl</value>
				<value>com.elasticpath.domain.catalog.impl.DigitalAssetImpl</value>
				<value>com.elasticpath.domain.catalog.impl.AbstractLocaleDependantFieldsImpl</value>
				<value>com.elasticpath.domain.catalog.impl.ProductAssociationImpl</value>
				<value>com.elasticpath.domain.catalog.impl.ProductCategoryImpl</value>
				<value>com.elasticpath.domain.catalog.impl.ProductImpl</value>
				<value>com.elasticpath.domain.catalog.impl.ProductLocaleDependantFieldsImpl</value>
				<value>com.elasticpath.domain.catalog.impl.ProductSkuImpl</value>
				<value>com.elasticpath.domain.catalog.impl.ProductTypeImpl</value>
				<value>com.elasticpath.domain.skuconfiguration.impl.JpaAdaptorOfSkuOptionValueImpl</value>
				<value>com.elasticpath.domain.skuconfiguration.impl.SkuOptionImpl</value>
				<value>com.elasticpath.domain.skuconfiguration.impl.SkuOptionValueImpl</value>
				<value>com.elasticpath.domain.misc.impl.SkuOptionValueLocalizedPropertyValueImpl</value>
				<value>com.elasticpath.domain.misc.impl.SkuOptionLocalizedPropertyValueImpl</value>
				<value>com.elasticpath.domain.rules.impl.AbstractRuleElementImpl</value>
				<value>com.elasticpath.domain.rules.impl.CatalogCurrencyAmountDiscountActionImpl</value>
				<value>com.elasticpath.domain.rules.impl.LimitedUseCouponCodeConditionImpl</value>
				<value>com.elasticpath.domain.rules.impl.CartAnySkuPercentDiscountActionImpl</value>
				<value>com.elasticpath.domain.rules.impl.SkuInCartConditionImpl</value>
				<value>com.elasticpath.domain.rules.impl.ProductConditionImpl</value>
				<value>com.elasticpath.domain.rules.impl.AbstractRuleExceptionImpl</value>
				<value>com.elasticpath.domain.rules.impl.AbstractRuleImpl</value>
				<value>com.elasticpath.domain.sellingcontext.impl.SellingContextImpl</value>
				<value>com.elasticpath.domain.rules.impl.AppliedRuleImpl</value>
				<value>com.elasticpath.domain.rules.impl.PromotionRuleImpl</value>
				<value>com.elasticpath.domain.rules.impl.RuleParameterImpl</value>
				<value>com.elasticpath.domain.rules.impl.RuleSetImpl</value>
				<value>com.elasticpath.domain.catalog.impl.CatalogImpl</value>
				<value>com.elasticpath.domain.catalog.impl.CatalogLocaleImpl</value>
				<value>com.elasticpath.domain.catalog.impl.CategoryImpl</value>
				<value>com.elasticpath.domain.catalog.impl.LinkedCategoryImpl</value>
				<value>com.elasticpath.domain.attribute.impl.AttributeGroupAttributeImpl</value>
				<value>com.elasticpath.domain.attribute.impl.AttributeImpl</value>
				<value>com.elasticpath.domain.store.impl.StoreImpl</value>
				<value>com.elasticpath.domain.store.impl.WarehouseImpl</value>
				<value>com.elasticpath.domain.attribute.impl.ProductTypeProductAttributeImpl</value>
				<value>com.elasticpath.domain.pricing.impl.BaseAmountImpl</value>
			</set>
		</property>
		<property name="nonAuditableNamedQueries">
			<set>
				<!-- <value>DELETE_SHOPPING_CONTEXT_BY_UID_LIST</value> -->
			</set>
		</property>
		<property name="metadataMap" ref="persistenceListenerMetadataMap"/>
	</bean>

	<bean id="changeSetPersistenceListener" class="com.elasticpath.persistence.impl.ChangeSetPersistenceListener">
		<property name="beanFactory" ref="coreBeanFactory"/>
		<property name="metadataMap" ref="persistenceListenerMetadataMap"/>
		<property name="ignoreClasses">
			<set>
				<value>com.elasticpath.domain.changeset.impl.ChangeSetImpl</value>
				<value>com.elasticpath.domain.objectgroup.impl.BusinessObjectGroupMemberImpl</value>
				<value>com.elasticpath.domain.objectgroup.impl.BusinessObjectMetadataImpl</value>
				<value>com.elasticpath.domain.pricing.impl.BaseAmountImpl</value>
			</set>
		</property>
	</bean>

	<bean id="persistablePostLoadListener"
		  class="com.elasticpath.persistence.impl.PersistablePostLoadListener">
		<property name="postLoadStrategyBeanIds" ref="postLoadStrategyBeanIds"/>
		<property name="beanFactory" ref="coreBeanFactory"/>
	</bean>

	<bean id="auditDao" parent="txProxyTemplate">
		<property name="target">
				<bean class="com.elasticpath.service.audit.impl.AuditDaoImpl" >
					<property name="beanFactory" ref="coreBeanFactory"/>
					<property name="persistenceEngine" ref="persistenceEngineTarget"/>
					<property name="changeSetEnabledProvider">
						<settings:setting path="COMMERCE/SYSTEM/CHANGESETS/enable" systemPropertyOverrideKey="ep.changesets.enabled"/>
					</property>
				</bean>
		</property>
	</bean>

	<util:list id="postLoadStrategyBeanIds">
		<value>customerPostLoadStrategy</value>
		<value>productTypePostLoadStrategy</value>
		<value>productSkuOptionValuePostLoadStrategy</value>
	</util:list>

	<util:list id="persistenceEngineOperationListeners">
		<!--<ref bean="auditEntityListener"/>-->  <!--Must also be registered in the EntityManagerFactory-->
		<ref bean="entityModifiedListener"/>
	</util:list>

	<!-- Has a dependency of an applicationInitialization bean which can do any initialization the application requires -->
	<!-- before the persistence engine is created. -->
	<bean id="persistenceEngine" class="org.springframework.aop.framework.ProxyFactoryBean" depends-on="applicationInitialization">
		<property name="proxyInterfaces"
				  value="com.elasticpath.persistence.api.PersistenceEngine,com.elasticpath.persistence.openjpa.JpaPersistenceEngine"/>
		<property name="target">
			<ref bean="persistenceEngineTarget"/>
		</property>
	</bean>

	<bean id="entityManager" class="org.springframework.orm.jpa.support.SharedEntityManagerBean">
		<property name="entityManagerFactory">
			<ref bean="entityManagerFactory"/>
		</property>
	</bean>

	<bean id="persistenceEngineTarget" class="com.elasticpath.persistence.openjpa.impl.JpaPersistenceEngineImpl" init-method="init">

		<property name="sessionFactory" ref="sessionFactory"/>
		<property name="entityManager" ref="entityManager"/>

		<property name="transactionManager" ref="transactionManager"/>
		<property name="persistenceEngineOperationListeners" ref="persistenceEngineOperationListeners"/>

		<property name="fetchPlanHelper" ref="fetchPlanHelper"/>
		<property name="queryReaderFactory" ref="queryReaderFactory"/>
	</bean>

	<bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
		<property name="entityManagerFactory" ref="entityManagerFactory"/>
	</bean>

	<!-- Read/Write Entity Manager Factory -->
	<bean id="basePersistenceUnitManager" class="com.elasticpath.persistence.openjpa.impl.OverrideAllowingPersistenceUnitManager">
		<property name="defaultPersistenceUnitName" value="commerce-persistence-unit"/>
		<property name="persistenceXmlLocation" value="classpath*:META-INF/jpa-persistence.xml"/>
		<property name="persistenceUnitPostProcessors" ref="persistenceUnitPostProcessors"/>
	</bean>

	<bean id="persistenceUnitManager" parent="basePersistenceUnitManager">
		<property name="defaultDataSource" ref="dataSource"/>
	</bean>

	<bean id="abstractEntityManagerFactory" class="com.elasticpath.persistence.openjpa.impl.ConfigurableLocalContainerEntityManagerFactoryBean"
		  init-method="getObject"
		  abstract="true">
		<property name="persistenceUnitManager" ref="persistenceUnitManager"/>
		<property name="lifecycleListeners" ref="entityManagerLifecycleListeners"/>
		<property name="hdsSupportSwitch" ref="hdsSupportSwitch"/>
	</bean>

	<bean id="entityManagerFactory" parent="abstractEntityManagerFactory" depends-on="elasticPath,coreBeanFactory"/>

	<bean id="sessionFactory" class="com.elasticpath.persistence.openjpa.impl.JpaSessionFactoryImpl">
		<property name="entityManagerFactory" ref="entityManagerFactory"/>
		<property name="transactionManager" ref="transactionManager"/>
	</bean>

	<bean id="dbTxIsolationValidator" class="com.elasticpath.persistence.openjpa.impl.DbTxIsolationValidator"
		  init-method="verifyTxIsolationIsReadCommitted">
		<property name="persistenceEngine" ref="persistenceEngine"/>
	</bean>

</beans>
