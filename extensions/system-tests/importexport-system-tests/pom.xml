<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		 xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
	<modelVersion>4.0.0</modelVersion>
	<parent>
		<groupId>com.elasticpath.extensions</groupId>
		<artifactId>commerce-system-tests</artifactId>
		<version>0.0.0-SNAPSHOT</version>
	</parent>

	<artifactId>ep-importexport-system-tests</artifactId>
	<name>ImportExport Tool System Tests</name>
	<description>Import/Export Tool System Tests</description>

	<properties>
		<cargo.plugin.version>1.2.4</cargo.plugin.version>
		<h2database.version>1.3.172</h2database.version>
		<ep.cortex.itest.port.http>8080</ep.cortex.itest.port.http>
		<epdb.maven.groupId>com.h2database</epdb.maven.groupId>
		<epdb.maven.artifactId>h2</epdb.maven.artifactId>
		<epdb.maven.version>${h2database.version}</epdb.maven.version>
		<importexport.cli.directory>${project.build.directory}/cli/ext-importexport-cli-${project.version}</importexport.cli.directory>
		<ep.importexport.systemtestsdb.url>jdbc:h2:file:${project.build.directory}/database/SMOKETESTDB;AUTO_SERVER=TRUE</ep.importexport.systemtestsdb.url>
		<ep.importexport.systemtestsdb.username>sa</ep.importexport.systemtestsdb.username>
		<ep.importexport.systemtestsdb.password>sa</ep.importexport.systemtestsdb.password>
		<ep.importexport.systemtestsdb.driver>org.h2.Driver</ep.importexport.systemtestsdb.driver>
		<ep.importexport.systemtests.searchurl>http://localhost:${ep.importexport.systemtests.search.port.http}${ep.search.contextUrl}</ep.importexport.systemtests.searchurl>
	</properties>

	<dependencies>
		<dependency>
			<groupId>com.elasticpath.extensions</groupId>
			<artifactId>ext-search-webapp</artifactId>
			<type>war</type>
		</dependency>
		<dependency>
			<groupId>com.h2database</groupId>
			<artifactId>h2</artifactId>
		</dependency>
		<dependency>
			<groupId>io.cucumber</groupId>
			<artifactId>cucumber-java</artifactId>
		</dependency>
		<dependency>
			<groupId>io.cucumber</groupId>
			<artifactId>cucumber-junit</artifactId>
		</dependency>
		<dependency>
			<groupId>junit</groupId>
			<artifactId>junit</artifactId>
		</dependency>
		<dependency>
			<groupId>com.elasticpath</groupId>
			<artifactId>ep-core-test-utils</artifactId>
		</dependency>
		<dependency>
			<groupId>com.elasticpath.extensions</groupId>
			<artifactId>ext-importexport-cli</artifactId>
			<classifier>bin</classifier>
			<type>zip</type>
		</dependency>
	</dependencies>

	<profiles>
		<profile>
			<id>run-tests</id>
			<activation>
				<property>
					<name>!skipAllTests</name>
				</property>
			</activation>
			<build>
				<testResources>
					<testResource>
						<directory>src/test/cucumber</directory>
					</testResource>
					<testResource>
						<directory>src/test/resources</directory>
					</testResource>
					<testResource>
						<directory>src/test/filtered-resources</directory>
						<filtering>true</filtering>
					</testResource>
				</testResources>
				<pluginManagement>
					<plugins>
						<plugin>
							<groupId>org.codehaus.cargo</groupId>
							<artifactId>cargo-maven2-plugin</artifactId>
							<version>${cargo.plugin.version}</version>
							<configuration>
								<wait>false</wait>
								<container>
									<containerId>tomcat7x</containerId>
									<artifactInstaller>
										<groupId>org.apache.tomcat</groupId>
										<artifactId>tomcat</artifactId>
										<version>${tomcat.version}</version>
										<type>tar.gz</type>
									</artifactInstaller>
									<timeout>600000</timeout>
									<dependencies>
										<dependency>
											<groupId>com.h2database</groupId>
											<artifactId>h2</artifactId>
										</dependency>
									</dependencies>
								</container>
								<configuration>
									<home>${project.build.directory}/tomcat7x/container</home>
									<properties>
										<cargo.logging>medium</cargo.logging>
										<cargo.servlet.port>${ep.importexport.systemtests.search.port.http}</cargo.servlet.port>
										<cargo.tomcat.ajp.port>${cargo.tomcat.ajp.port}</cargo.tomcat.ajp.port>
										<cargo.rmi.port>${cargo.rmi.port}</cargo.rmi.port>
										<cargo.tomcat.shutdown.port>${cargo.tomcat.shutdown.port}</cargo.tomcat.shutdown.port>
										<cargo.datasource.datasource>
											<![CDATA[cargo.datasource.url=${ep.importexport.systemtestsdb.url};MULTI_THREADED=1|
										cargo.datasource.driver=${ep.importexport.systemtestsdb.driver}|
										cargo.datasource.username=${ep.importexport.systemtestsdb.username}|
										cargo.datasource.password=${ep.importexport.systemtestsdb.password}|
										cargo.datasource.jndi=jdbc/epjndi]]>
										</cargo.datasource.datasource>
									</properties>
								</configuration>
								<deployables>
									<deployable>
										<groupId>com.elasticpath.extensions</groupId>
										<artifactId>ext-search-webapp</artifactId>
										<type>war</type>
										<pingTimeout>600000</pingTimeout>
										<properties>
											<context>${ep.search.contextUrl}</context>
										</properties>
									</deployable>
								</deployables>
							</configuration>
						</plugin>
						<!--This plugin's configuration is used to store Eclipse m2e settings only. It has no influence on the Maven build itself.-->
						<plugin>
							<groupId>org.eclipse.m2e</groupId>
							<artifactId>lifecycle-mapping</artifactId>
							<version>${lifecycle-mapping-plugin.version}</version>
							<configuration>
								<lifecycleMappingMetadata>
									<pluginExecutions>
										<pluginExecution>
											<pluginExecutionFilter>
												<groupId>org.codehaus.mojo</groupId>
												<artifactId>build-helper-maven-plugin</artifactId>
												<versionRange>[${build-helper.maven.plugin.version},)</versionRange>
												<goals>
													<goal>reserve-network-port</goal>
												</goals>
											</pluginExecutionFilter>
											<action>
												<execute/>
											</action>
										</pluginExecution>
										<pluginExecution>
											<pluginExecutionFilter>
												<groupId>org.apache.maven.plugins</groupId>
												<artifactId>maven-dependency-plugin</artifactId>
												<versionRange>[2.4,)</versionRange>
												<goals>
													<goal>copy</goal>
													<goal>copy-db-dependency</goal>
												</goals>
											</pluginExecutionFilter>
											<action>
												<execute/>
											</action>
										</pluginExecution>
										<pluginExecution>
											<pluginExecutionFilter>
												<groupId>com.elasticpath.tools</groupId>
												<artifactId>ep-core-tool</artifactId>
												<versionRange>[610.0.0,)</versionRange>
												<goals>
													<goal>bulk-set-settings</goal>
												</goals>
											</pluginExecutionFilter>
											<action>
												<execute/>
											</action>
										</pluginExecution>
									</pluginExecutions>
								</lifecycleMappingMetadata>
							</configuration>
						</plugin>
					</plugins>
				</pluginManagement>
				<plugins>
					<plugin>
						<artifactId>maven-pmd-plugin</artifactId>
					</plugin>
					<plugin>
						<artifactId>maven-checkstyle-plugin</artifactId>
					</plugin>
					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>build-helper-maven-plugin</artifactId>
						<executions>
							<execution>
								<id>reserve-network-port</id>
								<goals>
									<goal>reserve-network-port</goal>
								</goals>
								<phase>generate-sources</phase>
								<configuration>
									<portNames>
										<portName>ep.importexport.systemtests.search.port.http</portName>
										<portName>cargo.tomcat.ajp.port</portName>
										<portName>cargo.rmi.port</portName>
										<portName>cargo.tomcat.shutdown.port</portName>
									</portNames>
								</configuration>
							</execution>
						</executions>
					</plugin>
					<!-- Unpack import export CLI tool-->
					<plugin>
						<artifactId>maven-dependency-plugin</artifactId>
						<version>2.4</version>
						<executions>
							<execution>
								<id>unpack-import-export-cli</id>
								<phase>process-resources</phase>
								<goals>
									<goal>unpack</goal>
								</goals>
								<configuration>
									<skip>${skipITests}</skip>
									<artifactItems>
										<artifactItem>
											<groupId>com.elasticpath.extensions</groupId>
											<artifactId>ext-importexport-cli</artifactId>
											<classifier>bin</classifier>
											<type>zip</type>
										</artifactItem>
									</artifactItems>
									<outputDirectory>${project.build.directory}/cli</outputDirectory>
								</configuration>
							</execution>
							<execution>
								<id>unpack-database</id>
								<phase>process-resources</phase>
								<goals>
									<goal>unpack</goal>
								</goals>
								<configuration>
									<artifactItems>
										<artifactItem>
											<groupId>com.elasticpath.extensions</groupId>
											<artifactId>smoketest-h2-database</artifactId>
											<version>${project.version}</version>
											<overWrite>true</overWrite>
											<type>zip</type>
											<outputDirectory>${project.build.directory}/database</outputDirectory>
										</artifactItem>
									</artifactItems>
								</configuration>
							</execution>
							<execution>
								<id>copy-db-dependency</id>
								<phase>process-resources</phase>
								<goals>
									<goal>copy</goal>
								</goals>
								<configuration>
									<artifactItems>
										<artifactItem>
											<groupId>com.h2database</groupId>
											<artifactId>h2</artifactId>
											<type>jar</type>
											<outputDirectory>${importexport.cli.directory}/dependencies</outputDirectory>
										</artifactItem>
									</artifactItems>
								</configuration>
							</execution>
						</executions>
						<configuration>
							<skip>${skipITests}</skip>
						</configuration>
					</plugin>
					<plugin>
						<artifactId>maven-resources-plugin</artifactId>
						<executions>
							<!-- This is required to run after the maven dependency plugin. Curently it runs after because of the alphabetical ordering
								 of the plugins.-->
							<execution>
								<id>copy-import-export-resources</id>
								<phase>process-resources</phase>
								<goals>
									<goal>copy-resources</goal>
								</goals>
								<configuration>
									<outputDirectory>${importexport.cli.directory}</outputDirectory>
									<resources>
										<resource>
											<directory>src/test/resources/import-export-resources</directory>
											<filtering>true</filtering>
										</resource>
									</resources>
								</configuration>
							</execution>
						</executions>
					</plugin>
					<plugin>
						<groupId>com.elasticpath.tools</groupId>
						<artifactId>ep-core-tool</artifactId>
						<configuration>
							<skip>${skipITests}</skip>
							<jdbcUrl>${ep.importexport.systemtestsdb.url}</jdbcUrl>
							<jdbcDriverClass>${ep.importexport.systemtestsdb.driver}</jdbcDriverClass>
							<jdbcPassword>${ep.importexport.systemtestsdb.password}</jdbcPassword>
							<jdbcUsername>${ep.importexport.systemtestsdb.username}</jdbcUsername>
							<jdbcConnectionPoolMinIdle>0</jdbcConnectionPoolMinIdle>
							<jdbcConnectionPoolMaxIdle>0</jdbcConnectionPoolMaxIdle>
						</configuration>
						<executions>
							<execution>
								<id>override-settings</id>
								<phase>process-test-resources</phase>
								<goals>
									<goal>bulk-set-settings</goal>
								</goals>
								<configuration>
									<settings>
										<setting>
											COMMERCE/SYSTEM/SEARCH/searchHost@default=${ep.importexport.systemtests.searchurl}
										</setting>
									</settings>
								</configuration>
							</execution>
							<execution>
								<id>build-indexes</id>
								<phase>integration-test</phase>
								<goals>
									<goal>request-reindex</goal>
								</goals>
								<configuration>
									<wait>true</wait>
								</configuration>
							</execution>
						</executions>
					</plugin>
					<plugin>
						<groupId>org.codehaus.cargo</groupId>
						<artifactId>cargo-maven2-plugin</artifactId>
						<executions>
							<execution>
								<id>start-container</id>
								<phase>pre-integration-test</phase>
								<goals>
									<goal>start</goal>
								</goals>
							</execution>
							<execution>
								<id>stop-container</id>
								<phase>post-integration-test</phase>
								<goals>
									<goal>stop</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<skip>${skipITests}</skip>
						</configuration>
					</plugin>
					<plugin>
						<groupId>org.apache.maven.plugins</groupId>
						<artifactId>maven-failsafe-plugin</artifactId>
						<version>2.11</version>
						<executions>
							<execution>
								<id>integration-test</id>
								<phase>integration-test</phase>
								<goals>
									<goal>integration-test</goal>
								</goals>
							</execution>
							<execution>
								<id>verify</id>
								<phase>verify</phase>
								<goals>
									<goal>verify</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<skip>${skipITests}</skip>
							<systemPropertyVariables>
								<importexport.cli.directory>${importexport.cli.directory}</importexport.cli.directory>
							</systemPropertyVariables>
						</configuration>
					</plugin>
				</plugins>
			</build>
		</profile>
	</profiles>

</project>
